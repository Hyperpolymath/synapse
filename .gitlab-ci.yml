# SPDX-License-Identifier: MIT
# GitLab CI/CD Pipeline for Synapse
# Runs on every push and merge request

stages:
  - lint
  - build
  - test
  - validate

variables:
  ZIG_VERSION: "0.13.0"

# Cache Zig downloads between jobs
cache:
  key: zig-${ZIG_VERSION}
  paths:
    - zig/

.install_zig: &install_zig
  before_script:
    - |
      if [ ! -d "zig" ]; then
        curl -L "https://ziglang.org/download/${ZIG_VERSION}/zig-linux-x86_64-${ZIG_VERSION}.tar.xz" | tar -xJ
        mv zig-linux-x86_64-${ZIG_VERSION} zig
      fi
    - export PATH="$PWD/zig:$PATH"
    - zig version

# Stage: Lint
lint:format:
  stage: lint
  <<: *install_zig
  script:
    - zig fmt --check src/
    - zig fmt --check build.zig
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

lint:spdx:
  stage: lint
  script:
    - |
      for f in $(find src -name "*.zig") build.zig examples/rust/models.rs; do
        if ! grep -q "SPDX-License-Identifier" "$f"; then
          echo "Missing SPDX header: $f"
          exit 1
        fi
      done
    - echo "All SPDX headers present"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Stage: Build
build:
  stage: build
  <<: *install_zig
  script:
    - zig build
    - ./zig-out/bin/synapse --help
  artifacts:
    paths:
      - zig-out/bin/synapse
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Stage: Test
test:unit:
  stage: test
  <<: *install_zig
  script:
    - zig build test
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

test:generate:
  stage: test
  <<: *install_zig
  needs: ["build"]
  script:
    - ./zig-out/bin/synapse --input examples/rust/models.rs --output examples/swift/Generated.swift
    - test -f examples/swift/Generated.swift
    - grep -q "AUTO-GENERATED BY SYNAPSE" examples/swift/Generated.swift
    - grep -q "ReefViewModel" examples/swift/Generated.swift
    - grep -q "PlayerStateViewModel" examples/swift/Generated.swift
    - echo "Generation test passed"
  artifacts:
    paths:
      - examples/swift/Generated.swift
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Stage: Validate
validate:rsr:
  stage: validate
  script:
    - |
      echo "Checking RSR Gold compliance..."
      for f in README.md LICENSE.txt SECURITY.md CODE_OF_CONDUCT.md CONTRIBUTING.adoc \
               FUNDING.yml GOVERNANCE.adoc MAINTAINERS.md .gitignore .gitattributes \
               REVERSIBILITY.md CHANGELOG.md ROADMAP.md CLAUDE.md; do
        if [ ! -f "$f" ]; then
          echo "Missing: $f"
          exit 1
        fi
      done
      echo "All RSR documentation present"
    - |
      echo "Checking .well-known directory..."
      for f in security.txt ai.txt humans.txt provenance.json; do
        if [ ! -f ".well-known/$f" ]; then
          echo "Missing: .well-known/$f"
          exit 1
        fi
      done
      echo "All .well-known files present"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Release job (manual trigger on tags)
release:
  stage: validate
  <<: *install_zig
  script:
    - zig build -Doptimize=ReleaseSafe
    - |
      echo "Creating release artifacts..."
      mkdir -p release
      cp zig-out/bin/synapse release/synapse-linux-x86_64
      cp README.md LICENSE.txt release/
      tar -czvf synapse-${CI_COMMIT_TAG}-linux-x86_64.tar.gz -C release .
  artifacts:
    paths:
      - synapse-*.tar.gz
    expire_in: never
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
  when: manual
